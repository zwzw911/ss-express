var dbStructure=require("./db_structure"),userModel=dbStructure.userModel,articleModel=dbStructure.articleModel,keyModel=dbStructure.keyModel,input_validate=require("../error_define/input_validate").input_validate,errorRecorder=require("../express_component/recorderError").recorderError,runtimeDbError=require("../error_define/runtime_db_error").runtime_db_error,runtimeNodeError=require("../error_define/runtime_node_error").runtime_node_error,general=require("../assist/general").general,miscellaneous=require("../assist_function/miscellaneous").func,async=require("async"),pagination=require("../express_component/pagination").pagination,convertKeyword=function(a,b){},getSearchResult=function(a,b,c){var d=b;keyModel.aggregate([{$match:{key:{$in:{$toLower:a}}}},{$project:{_id:1,key:1}},{$group:{_id:null,keys:{$push:"$key"}}}],function(a,b){if(a)return errorRecorder({rc:a.code,msg:a.errmsg},"searchResult","getSearchResult"),c(a,runtimeDbError.key.aggregateByKeyName);if(0===b[0].length)return c(null,runtimeNodeError.searchResult.notMatchArticle);var e=b[0].keys;articleModel.aggregate([{$unwind:"$keys"},{$match:{keys:{$in:e}}},{$group:{_id:"$_id",count:{$sum:1}}},{$sort:{count:-1}}],function(a,b){if(a)return errorRecorder({rc:a.code,msg:a.errmsg},"searchResult","getSearchResult"),c(a,runtimeDbError.article.aggregateByKeyName);if(0===b.length)return c(null,{rc:0,msg:void 0});var e=b.length,f=pagination(e,d,general.searchResultPageSize,general.searchResultPageLength),g=f.curPage,h={skip:general.searchResultPageSize*(g-1),limit:general.searchResultPageSize},i=miscellaneous.extractKey("_id",b),j=[{path:"author",model:"users",select:"-_id name"}];articleModel.find({_id:{$in:i}},"-_id hashId author title htmlContent pureContent keys mDate",h,function(a,b){return a?(errorRecorder({rc:a.code,msg:a.errmsg},"searchResult","getSearchResult"),c(a,runtimeDbError.article.find)):void articleModel.populate(b,j,function(a,b){return c(null,{rc:0,msg:{results:b,pagination:f}})})})})})},getSearchResult1=function(a,b,c){var d=b,e=[{$match:{$text:{$search:a}}},{$sort:{rank:{$meta:"textScore"}}},{$project:{_id:1}}];articleModel.aggregate(e,function(a,b){if(a)return errorRecorder({rc:a.code,msg:a.errmsg},"searchResult","getSearchResult"),c(a,runtimeDbError.article.find);if(0===b.length)return c(null,{rc:0,msg:void 0});var e=b.length,f=pagination(e,d,general.searchResultPageSize,general.searchResultPageLength),g=f.curPage,h={skip:general.searchResultPageSize*(g-1),limit:general.searchResultPageSize},i=miscellaneous.extractKey("_id",b),j=[{path:"author",model:"users",select:"-_id name"}];articleModel.find({_id:{$in:i}},"-_id hashId author title htmlContent pureContent keys mDate",h,function(a,b){return a?(errorRecorder({rc:a.code,msg:a.errmsg},"searchResult","getSearchResult"),c(a,runtimeDbError.article.find)):void articleModel.populate(b,j,function(a,b){return c(null,{rc:0,msg:{results:b,pagination:f}})})})})};exports.searchResultDbOperation={getSearchResult:getSearchResult,getSearchResult1:getSearchResult1};