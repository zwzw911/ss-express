var dbStructure=require("./db_structure"),articleModel=dbStructure.articleModel,folderModel=dbStructure.folderModel,userModel=dbStructure.userModel,articleFolderModel=dbStructure.articleFolderModel,async=require("async"),errorRecorder=require("../express_component/recorderError").recorderError,general=require("../assist/general").general,pagination=require("../express_component/pagination").pagination,validateDb=require("../error_define/3rd_party_error_define").validateDb,input_validate=require("../error_define/input_validate").input_validate,runtimeDbError=require("../error_define/runtime_db_error").runtime_db_error,runtimeNodeError=require("../error_define/runtime_node_error").runtime_node_error,pagination=require("../express_component/pagination").pagination,validateFolder=input_validate.folder,validateArticleFolder=input_validate.articleFolder,validateArticle=input_validate.article,ifFolderOwner=function(a,b,c){folderModel.findById(b,"owner",function(b,d){return b?(errorRecorder({rc:b.code,msg:b.errmsg},"articleFolder","moveArticle"),c(b,runtimeDbError.folder.findById)):d.owner!=a?c(null,runtimeNodeError.folder.notFolderOwner):c(null,{rc:0,msg:null})})},readRootFolderId=function(a,b,c){if(!validateFolder.owner.type.define.test(a))return c(null,validateFolder.owner.type.client);var d=general.defaultRootFolderName;return-1===d.indexOf(b)?c(null,runtimeNodeError.folder.invalidateRootFolderName):void folderModel.find({owner:a,level:1,folderName:b,parentId:null},function(a,b){return a?(errorRecorder({rc:a.code,msg:a.err.errmsg},"folder","readRootFolderId"),c(a,runtimeDbError.folder.findTrashFolder)):[]===b?c(null,runtimeDbError.folder.rootFolderNotFind):1<b.length?c(null,runtimeDbError.folder.rootFolderMulti):c(null,{rc:0,msg:b[0]})})},ifDefaultFolder=function(a){return-1!=general.defaultRootFolderName.indexOf(a.folderName)&&null===a.parentId&&validateFolder.level.range.define.min===a.level},checkIfRootFolder=function(a,b){folderModel.findById(a,function(a,c){return a?(errorRecorder({rc:a.code,msg:a.errmsg},"folder","modifyFolderName"),b(null,runtimeDbError.folder.folderFindById)):null===c?b(null,runtimeDbError.folder.folderFindByIdNull):ifDefaultFolder(c)?b(null,{rc:0,msg:!0}):b(null,{rc:0,msg:!1})})},createRootFolder=function(a,b,c){var d=general.defaultRootFolderName;return-1===d.indexOf(b)?c(null,runtimeNodeError.folder.invalidateRootFolderName):void folderModel.find({owner:a,folderName:b,level:1,parentId:null},function(d,e){if(d)return errorRecorder({rc:d.code,msg:d.errmsg},"folder","createRootFolder"),c(d,runtimeDbError.folder.createRootFolder);if(1<e.length)return c(null,runtimeDbError.folder.rootFolderMulti);if(1===e.length)return c(null,{rc:0,msg:e});if(0===e.length){var e=new folderModel;e.folderName=b,e.owner=a,e.parentId=null,e.level=1,e.cDate=new Date,validateDb.folder(e,"folder","createRootFolder",function(a,b){return 0<b.rc?c(null,b):void e.save(function(a,b){return a?(errorRecorder({rc:a.code,msg:a.err.errmsg},"folder","createRootFolder"),c(a,runtimeDbError.folder.saveRootFolder)):c(null,{rc:0,msg:b})})})}})},readRootFolder=function(a,b,c){if(!validateFolder.owner.type.define.test(a))return c(null,validateFolder.owner.type.client);var d=general.defaultRootFolderName;return-1===d.indexOf(b)?c(null,runtimeNodeError.folder.invalidateRootFolderName):void readRootFolderId(a,b,function(a,b){return c(null,b)})},readFolder=function(a,b,c){return validateFolder.owner.type.define.test(a)?validateFolder._id.type.define.test(b)?void ifFolderOwner(a,b,function(d,e){return 0<e.rc?c(null,e):void folderModel.find({owner:a,parentId:b},function(a,b){return a?(errorRecorder({rc:a.code,msg:a.errmsg},"folder","readFolder"),c(a,runtimeDbError.folder.readFolder)):c(null,{rc:0,msg:b})})}):c(null,validateFolder._id.type.client):c(null,validateFolder.owner.type.client)},modifyFolderName=function(a,b,c,d,e){return validateFolder.owner.type.define.test(a)?validateFolder._id.type.define.test(b)?validateFolder.folderName.type.define.test(c)&&validateFolder.folderName.type.define.test(d)?void folderModel.findById(b,function(b,f){return b?(errorRecorder({rc:b.code,msg:b.errmsg},"folder","modifyFolderName"),e(null,runtimeDbError.folder.folderFindById)):null===f?e(null,runtimeDbError.folder.folderFindByIdNull):1<f.length?e(null,runtimeDbError.folder.folderFindByIdMulti):ifDefaultFolder(f)?e(null,runtimeNodeError.folder.cantMoveDefaultFolder):f.owner!=a?e(null,runtimeNodeError.folder.notOwner):f.folderName!=c?e(null,runtimeNodeError.folder.folderNameNotMatch):(f.folderName=d,void f.save(function(a,b){return a?(errorRecorder({rc:a.code,msg:a.errmsg},"folder","modifyFolderName"),e(a,runtimeNodeError.folder.updateFolderNameFail)):e(null,{rc:0,msg:b})}))}):e(null,validateFolder.folderName.type.client):e(null,validateFolder._id.type.client):e(null,validateFolder.owner.type.client)},moveFolder=function(a,b,c,d,e){return validateFolder.owner.type.define.test(a)?validateFolder._id.type.define.test(b)&&validateFolder._id.type.define.test(c)&&validateFolder._id.type.define.test(d)?c===d?e(null,{rc:0,msg:null}):void folderModel.findById(b,function(c,f){return c?(errorRecorder({rc:c.code,msg:c.errmsg},"folder","modifyFolderName"),e(null,runtimeDbError.folder.folderFindById)):null===f?e(null,runtimeDbError.folder.folderFindByIdNull):ifDefaultFolder(f)?e(null,runtimeNodeError.folder.cantMoveDefaultFolder):void folderModel.findById(d,function(c,f){if(c)return errorRecorder({rc:c.code,msg:c.errmsg},"folder","modifyFolderName"),e(null,runtimeDbError.folder.folderFindById);if(null===f)return e(null,runtimeDbError.folder.folderFindByIdNull);if(1<f.length)return e(null,runtimeDbError.folder.folderFindByIdMulti);if(a!=f.owner)return e(null,runtimeNodeError.folder.notNewFolderOwner);var g=f.level;return validateFolder.level.range.define.max<=g||validateFolder.level.range.define.min>g?e(null,runtimeNodeError.folder.parentLevelNotInRange):void folderModel.findById(b,function(b,c){return b?(errorRecorder({rc:b.code,msg:b.errmsg},"folder","modifyFolderName"),e(null,runtimeDbError.folder.folderFindById)):null===c?e(null,runtimeDbError.folder.folderFindByIdNull):1<c.length?e(null,runtimeDbError.folder.folderFindByIdMulti):a!=c.owner?e(null,runtimeNodeError.folder.notOwner):(c.parentId=d,c.level=g+1,void c.save(function(a,b){return a?(errorRecorder({rc:a.code,msg:a.errmsg},"folder","modifyFolderName"),e(null,runtimeDbError.folder.saveFolder)):e(null,{rc:0,msg:b})}))})})}):e(null,validateFolder._id.type.client):e(null,validateFolder.owner.type.client)},createNewFolder=function(a,b,c,d){return validateFolder.owner.type.define.test(a)?validateFolder._id.type.define.test(b)?validateFolder.folderName.type.define.test(c)?void folderModel.findById(b,function(e,f){if(e)return errorRecorder({rc:e.code,msg:e.errmsg},"folder","createNewFolder"),d(null,runtimeDbError.folder.folderFindById);if(null===f)return d(null,runtimeDbError.folder.folderFindByIdNull);if(1<f.length)return d(null,runtimeDbError.folder.folderFindByIdMulti);if(a!=f.owner)return d(null,runtimeNodeError.folder.notNewFolderOwner);var g=f.level;if(validateFolder.level.range.define.max<=g||validateFolder.level.range.define.min>g)return d(null,runtimeNodeError.folder.parentLevelNotInRange);var h=new folderModel;h.folderName=c,h.owner=a,h.parentId=b,h.level=g+1,h.save(function(a,b){return a?(errorRecorder({rc:a.code,msg:a.errmsg},"folder","modifyFolderName"),d(a,runtimeDbError.folder.saveFolder)):d(null,{rc:0,msg:b})})}):d(null,validateFolder.folderName.type.client):d(null,validateFolder._id.type.client):d(null,validateFolder.owner.type.client)},deleteFolder=function(a,b,c){return validateFolder.owner.type.define.test(a)?validateFolder._id.type.define.test(b)?void folderModel.findById(b,function(d,e){return d?(errorRecorder({rc:d.code,msg:d.errmsg},"folder","deleteFolder"),c(d,runtimeDbError.folder.folderFindById)):null===e?c(null,runtimeDbError.folder.folderFindByIdNull):1<e.length?c(null,runtimeDbError.folder.folderFindByIdMulti):ifDefaultFolder(e)?c(null,runtimeNodeError.folder.cantDeleteDefaultFolderName):a!=e.owner?c(null,runtimeNodeError.folder.notNewFolderOwner):void folderModel.remove({_id:b},function(a){return a?(errorRecorder({rc:a.code,msg:a.errmsg},"folder","deleteFolder"),c(a,runtimeDbError.folder.removeFolder)):c(null,{rc:0,msg:null})})}):c(null,validateFolder._id.type.client):c(null,validateFolder.owner.type.client)},countSubFolder=function(a,b,c){return validateFolder.owner.type.define.test(a)?validateFolder._id.type.define.test(b)?void ifFolderOwner(a,b,function(d,e){return 0<e.rc?c(null,e):void folderModel.count({owner:a,parentId:b},function(a,b){return a?(errorRecorder({rc:a.code,msg:a.errmsg},"folder","countSubFolder"),c(a,runtimeDbError.folder.countSubFolder)):c(null,{rc:0,msg:b})})}):c(null,validateFolder._id.type.client):c(null,validateFolder.owner.type.client)},readArticleNumInFolder=function(a,b){articleFolderModel.count({folderId:a},function(a,c){return a?b(a,runtimeDbError.articleFolder.countFail):b(null,{rc:0,msg:c})})},readArticleInFolder=function(a,b,c){if(!validateFolder.owner.type.define.test(a))return c(null,validateFolder.owner.type.client);if(!validateArticleFolder.folderId.type.define.test(b))return c(null,validateArticleFolder.folderId.type.client);var d=[{path:"articleId",model:"articles",select:"title state author hashId mDate"}];ifFolderOwner(a,b,function(e,f){return 0<f.rc?c(null,f):void articleFolderModel.find({folderId:b},"articleId",function(b,e){if(b)return errorRecorder({rc:b.code,msg:b.errmsg},"articleFolder","readArticleInFolder"),c(b,runtimeDbError.articleFolder.findSubArticle);if([]===e)return c(null,{rc:0,msg:[]});var f=(e.length,[]);async.forEachOf(e,function(b,c,e){b.populate(d,function(b,d){b&&e(b),d&&d.articleId.author==a&&(f[c]=d),e()})},function(a){return a?(errorRecorder({rc:a.code,msg:a.errmsg},"articleFolder","readArticleInFolder"),c(a,runtimeDbError.articleFolder.populateArticle)):c(null,{rc:0,msg:f})})})})},readArticleInFolderForPagination=function(a,b,c,d){return validateFolder.owner.type.define.test(a)?validateArticleFolder.folderId.type.define.test(b)?input_validate.regex.pageNum.test(c)?d(null,runtimeNodeError.articleFolder.pageNumWrong):void ifFolderOwner(a,b,function(e,f){return 0<f.rc?d(null,f):void countSubArticle(a,b,function(e,g){if(0<g.rc)return d(null.result1);var h=f.msg,i=pagination(h,c,general.articleFolderPageSize,general.articleFolderPageLength);articleFolderModel.find({folderId:b},"articleId",{limit:general.articleFolderPageSize,skip:(i.curPage-1)*general.articleFolderPageSize},function(b,c){if(b)return errorRecorder({rc:b.code,msg:b.errmsg},"articleFolder","readArticleInFolder"),d(b,runtimeDbError.articleFolder.findSubArticle);if(null===c)return d(null,{rc:0,msg:[]});for(var e=c.length,f=[],g=[{path:"articleId",model:"articles",select:"title author cDate mDate"}],h=0;e>h;h++)c[h].populate(g,function(b,c){return b?(errorRecorder({rc:b.code,msg:b.errmsg},"articleFolder","readArticleInFolder"),d(b,runtimeDbError.articleFolder.populateArticle)):void(c.author===a&&f.push(c))});return d(null,{rc:0,msg:f})})})}):d(null,validateArticleFolder.folderId.type.client):d(null,validateFolder.owner.type.client)},createArticleFolder=function(a,b,c,d){return validateFolder.owner.type.define.test(a)?validateArticleFolder.articleId.type.define.test(b)?validateArticleFolder.folderId.type.define.test(c)?void folderModel.findById(c,function(e,f){if(e)return errorRecorder({rc:e.code,msg:e.errmsg},"articleFolder","createArticleFolder"),d(e,runtimeDbError.folder.folderFindById);if(a!=f.owner)return d(null,runtimeNodeError.articleFolder.notFolderOwner);var g=new articleFolderModel;g.articleId=b,g.folderId=c,validateDb.articleFolder(g,"articleFolder","createArticleFolder",function(a,b){return 0<b.rc?d(null,b):void g.save(function(a,b){return a?(errorRecorder({rc:a.code,msg:a.errmsg},"articleFolder","createArticleFolder"),d(a,runtimeDbError.articleFolder.saveArticleFolder)):d(null,{rc:0,msg:{id:b._id,title:"新建文件",mDate:b.mDate,state:"正在编辑"}})})})}):d(null,validateArticleFolder.folderId.type.client):d(null,validateFolder._id.type.client):d(null,validateFolder.owner.type.client)},removeArticleFolder=function(a,b,c){return validateFolder.owner.type.define.test(a)?validateArticleFolder.articleId.type.define.test(b)?void readRootFolderId(a,"垃圾箱",function(d,e){if(0<e.rc)return c(null,e);var f=e.msg._id;ifFolderOwner(a,f,function(a,d){return 0<d.rc?c(null,d):void articleFolderModel.remove({folderId:f,articleId:b},function(a,d){return a?(errorRecorder({rc:a.code,msg:a.errmsg},"articleFolder","removeArticleFolder"),c(a,runtimeDbError.articleFolder.removeArticleFolder)):(articleModel.findByIdAndRemove(b,function(a,b){return a?(errorRecorder({rc:a.code,msg:a.errmsg},"articleFolder","removeArticleFolder"),c(a,runtimeDbError.article.findByIdAndRemove)):void 0}),c(null,{rc:0,msg:null}))})})}):c(null,validateArticleFolder.articleId.type.client):c(null,validateFolder.owner.type.client)},moveArticle=function(a,b,c,d,e){return validateFolder.owner.type.define.test(a)?validateArticle.hashId.type.define.test(b)?validateArticleFolder.folderId.type.define.test(c)&&validateArticleFolder.folderId.type.define.test(d)?c===d?e(null,{rc:0,msg:null}):void articleModel.find({hashId:b},function(b,f){if(b)return errorRecorder({rc:b.code,msg:b.errmsg},"articleFolder","moveArticle"),e(b,runtimeDbError.article.findByHashId);if(0===f.length)return e(b,runtimeDbError.article.findByHashIdNull);if(1<f.length)return e(b,runtimeDbError.article.findByHashIdMulti);var g=f[0]._id;ifFolderOwner(a,c,function(b,f){return 0<f.rc?e(null,f):void ifFolderOwner(a,d,function(a,b){return 0<b.rc?e(null,b):void articleFolderModel.find({folderId:c,articleId:g},function(a,b){return a?(errorRecorder({rc:a.code,msg:a.errmsg},"articleFolder","moveArticle"),e(a,runtimeDbError.articleFolder.find)):[]==b?e(a,runtimeDbError.articleFolder.findNull):1<b.length?e(a,runtimeDbError.articleFolder.findMulti):(b[0].folderId=d,void b[0].save(function(a,b){return a?(errorRecorder({rc:a.code,msg:a.errmsg},"articleFolder","moveArticle"),e(a,runtimeDbError.articleFolder.save)):e(null,{rc:0,msg:b})}))})})})}):e(null,validateArticleFolder.folderId.type.client):e(null,validateArticle.hashId.type.client):e(null,validateFolder.owner.type.client)},countSubArticle=function(a,b,c){return validateFolder._id.type.define.test(b)?void ifFolderOwner(a,b,function(a,d){return 0<d.rc?c(null,d):void articleFolderModel.count({folderId:b},function(a,b){return a?(errorRecorder({rc:a.code,msg:a.errmsg},"articleFolder","countSubArticle"),c(a,runtimeDbError.articleFolder.countSubArticle)):c(null,{rc:0,msg:b})})}):c(null,validateArticleFolder.folderId.type.client)};exports.personalArticleDbOperation={checkIfRootFolder:checkIfRootFolder,createRootFolder:createRootFolder,readRootFolder:readRootFolder,readFolder:readFolder,modifyFolderName:modifyFolderName,moveFolder:moveFolder,createNewFolder:createNewFolder,deleteFolder:deleteFolder,countSubFolder:countSubFolder,readArticleNumInFolder:readArticleNumInFolder,readArticleInFolder:readArticleInFolder,createArticleFolder:createArticleFolder,removeArticleFolder:removeArticleFolder,moveArticle:moveArticle,countSubArticle:countSubArticle};