var Canvas=require("canvas"),captchaImgPath=require("../assist/general").general.captchaImg_path,runtimeNodeError=require("../error_define/runtime_node_error").runtime_node_error,fs=require("fs"),defaultParams={expireDuration:1,resultMode:0,saveDir:captchaImgPath[0],fontRandom:!0,fontSize:20,fontType:"normal",fontWeight:"normal",fontFamily:"serfi",shadow:!0,size:4,inclineFactor:.25,width:80,height:32},validString="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ",validFontType=["normal","italic"],validFontWeight=["100","200","300","400","500","600","700","800","900","normal","bold","bolder","lighter"],validFontFamily=["serif","sans-serif","monospace","cursive","fantasy"],genRandomEle=function(a){var b=a.length,c=Math.round(Math.random()*(b-1));return a[c]},genRandomFontSetting=function(a){a.fontType=genRandomEle(validFontType),a.fontWeight=genRandomEle(validFontWeight),a.fontFamily=genRandomEle(validFontFamily)},convertToInt=function(a){return isNaN(parseInt(a))?!1:parseInt(a)},convertToFloat=function(a){return isNaN(parseFloat(a))?!1:parseFloat(a)},removeExpireFile=function(a,b){var c=(new Date).getTime();fs.readdir(a.saveDir,function(d,e){return d?b(d,runtimeNodeError.captcha.readDir):void e.forEach(function(d){tmpFile=d.split("."),(isNaN(parseInt(tmpFile[0]))||c-parseInt(tmpFile[0])>6e4*a.expireDuration)&&fs.unlink(a.saveDir+"/"+d,function(a,c){return a?b(a,runtimeNodeError.captcha.removeFile):b(null,{rc:0,msg:void 0})})})})},captcha=function(a,b){var c,d;c=convertToInt(a.expireDuration),!a.hasOwnProperty("expireDuration")||!1===c||0>c||c>60?a.expireDuration=1:a.expireDuration=c,c=convertToInt(a.resultMode),!a.hasOwnProperty("resultMode")||!1===c||0>c||c>2?a.resultMode=1:a.resultMode=c,a.hasOwnProperty("fontRandom")&&"boolean"==typeof a.fontRandom||(a.fontRandom=!0),a.hasOwnProperty("fontType")&&-1!==validFontType.indexOf(a.fontType)||(a.fontType="normal"),a.hasOwnProperty("fontWeight")&&-1!==validFontWeight.indexOf(a.fontWeight)||(a.fontWeight="normal"),c=convertToInt(a.fontSize),a.hasOwnProperty("fontSize")&&!1!==c?a.fontSize=c:a.fontSize=20,a.hasOwnProperty("fontFamily")&&-1!==validFontFamily.indexOf(a.fontFamily)||(a.fontFamily="serif"),a.hasOwnProperty("shadow")&&"boolean"==typeof a.shadow||(a.shadow=!0),c=convertToInt(a.size),!a.hasOwnProperty("size")||!1===c||2>c||c>6?a.size=4:a.size=c,d=convertToFloat(a.inclineFactor),!a.hasOwnProperty("inclineFactor")||0==d||0>d||d>1?a.inclineFactor=.25:a.inclineFactor=d;var e=Math.ceil(.5*a.fontSize*(1+a.inclineFactor)),f=Math.ceil(.7*a.fontSize*(1+a.inclineFactor)),g=e,h=Math.round(f/4),i=0,j=["rgb(255,165,0)","rgb(16,78,139)","rgb(0,139,0)","rgb(255,0,0)"],k="rgb(255,255,255)",l="rgb(153, 102, 102)",m=2*g+a.size*e+(a.size-1)*i;c=convertToInt(a.width),a.hasOwnProperty("width")?!1===c||m>c?a.width=m:a.width=c:a.width=80,g=Math.round((a.width-a.size*e-(a.size-1)*i)/2);var n=2*h+f;c=convertToInt(a.height),a.hasOwnProperty("height")?!1===c||n>c?a.height=n:a.height=c:a.height=32,h=Math.round((a.height-f)/2);var o=new Canvas(a.width,a.height),p=o.getContext("2d");if(p.fillStyle=k,p.fillRect(0,0,a.width,a.height),p.fillStyle=l,p.lineWidth=1,p.strokeRect(0,0,a.width,a.height),a.shadow){var q=Math.round(Math.random()*(j.length-1));p.shadowColor=j[q],p.shadowOffsetX=1,p.shadowOffsetY=1,p.shadowBlur=3}var r="";p.lineWidth=1,p.moveTo(g,h+Math.random()*f);var s=g+Math.random()*(a.width-2*g),t=h+Math.random()*(f/2),u=g+Math.random()*(a.width-2*g),v=h+f/2+Math.random()*(f/2),w=h+parseInt(f*Math.random());p.bezierCurveTo(s,v,u,t,a.width-g,w),p.stroke();for(var x=1;x<=a.size;x++){singleChar=validString.substr(parseInt(36*Math.random(),10),1),p.setTransform(1,Math.random()*a.inclineFactor,Math.random()*a.inclineFactor,1,g+(x-1)*i+(x-1)*e,Math.ceil(.7*a.fontSize)+h),p.lineWidth=1,a.fontRandom&&genRandomFontSetting(a),p.font=a.fontType+" "+a.fontSize.toString()+"px "+a.fontFamily;var y=parseInt(Math.random()*j.length);p.fillStyle=j[y];var z=Math.random()>.5;z?p.strokeText(singleChar,0,0):p.fillText(singleChar,0,0),r+=singleChar}if(1==a.resultMode){var A=require("fs");a.hasOwnProperty("saveDir")&&A.existsSync(a.saveDir)||captchaImgPath.forEach(function(b){!0===A.existsSync(b)&&(a.saveDir=b)});var B=(new Date).getTime()+Math.floor(1e3*Math.random())+".png",C=A.createWriteStream(a.saveDir+"/"+B),D=o.pngStream();D.on("data",function(a){C.write(a)}),D.on("end",function(){return b(null,r,B,a.saveDir)}),D.on("error",function(){throw new Error("save png failed")})}else 2==a.resultMode?o.toBuffer(function(a,c){return b(r,c)}):o.toDataURL("image/png",function(a,c){return b(r,c)})};exports.captcha={captcha:captcha,removeExpireFile:removeExpireFile};