var express=require("express"),router=express.Router(),searchResultDbOperation=require("./model/searchResult").searchResultDbOperation,general=require("./assist/general").general,miscellaneous=require("./assist_function/miscellaneous").func,generalFunc=require("./express_component/generalFunction").generateFunction,runtimeNodeError=require("./error_define/runtime_node_error").runtime_node_error,colorfulResult=function(a,b){var c=b.length;if(0===c)return!0;for(var d,e,f,g=a.length,h=0;g>h;h++)0==h?f=a[h]:(f+="|",f+=a[h]);d=new RegExp("("+f+")","gi"),e=new RegExp("("+f+")","i");for(var i,k,l,m,h=0;c>h;h++){b[h].title=b[h].title.replace(d,'<span class="text-danger">$1</span>');var n=b[h].keys.length;for(j=0;j<n;j++)b[h].keys[j]=b[h].keys[j].replace(d,'<span class="text-danger">$1</span>');if(void 0!==b[h].pureContent){var o=b[h].pureContent.match(e);null===o?b[h].pureContent=b[h].pureContent.substr(0,general.showContentLength):(l=o.index-parseInt(general.showContentLength/2),i=l>0?l:0,m=o.index+parseInt(general.showContentLength/2),k=m>b[h].pureContent.length?b[h].pureContent.length:m,b[h].pureContent=b[h].pureContent.substring(i,k),b[h].pureContent=b[h].pureContent.replace(d,'<span class="text-danger">$1</span>'))}}},convertDate=function(a){var b=[];if(0===a.length)return b;var c,d=["hashId","author","title","htmlContent","pureContent","keys","mDate"];return a.forEach(function(a){c={},d.forEach(function(b){"mDate"===b?c[b]=miscellaneous.expressFormatLongDate(a[b]):c[b]=a[b]}),b.push(c)}),b};router.get("/",function(a,b,c){void 0===a.session.state&&(a.session.state=2);var d=generalFunc.preCheck(a,!1);return d.rc>0?b.json(d):b.render("searchResult",{title:"搜索结果",year:(new Date).getFullYear()})}),router.post("/",function(a,b,c){void 0===a.session.state&&(a.session.state=2);var d=generalFunc.preCheck(a,!1);if(d.rc>0)return b.json(d);var e=a.body.wd,f=a.body.curPage;return""===e||void 0===e||null===e?b.redirect("searchPage"):void 0===f||f.toString()!==parseInt(f).toString()?b.json(runtimeNodeError.searchResult.pageNumWrong):(e=generalFunc.convertURLSearchString(e),void searchResultDbOperation.getSearchResult1(e,f,function(c,d){if(0===d.rc&&void 0!==d.msg&&void 0!==d.msg.results){var f=e.split(/\s+/);colorfulResult(f,d.msg.results),d.msg.userInfo=generalFunc.getUserInfo(a),d.msg.results=convertDate(d.msg.results)}return b.json(d)}))}),module.exports=router;