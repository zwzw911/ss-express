var ue_config=require("./assist/ueditor_config").ue_config,general=require("./assist/general").general,express=require("express"),router=express.Router(),fs=require("fs"),uploadDefine=require("./assist/upload_define").uploadDefine,mimes=require("./assist/mime").mimes,multiparty=require("multiparty"),async=require("async"),hash=require("./express_component/hashCrypt"),regex=require("./express_component/regex"),dbStructure=require("./model/db_structure"),articleModel=dbStructure.articleModel,attachmentModel=dbStructure.attachmentModel,innerImageModel=dbStructure.innerImageModel,dbOperation=require("./model/article").articleDboperation,assistFunc=require("./assist_function/article").assistFunc,recorderError=require("./express_component/recorderError").recorderError,input_validate=require("./error_define/input_validate").input_validate,generalDefine=require("./assist/general").general,runtimeNodeError=require("./error_define/runtime_node_error").runtime_node_error,pagination=require("./express_component/pagination").pagination,generalFunc=require("./express_component/generalFunction").generateFunction,isArticleOwner=function(a,b){if(1==a.session.state)for(var c=0;c<a.session.articleAuthor.length;c++)if(a.session.articleAuthor[c].authorId==a.session.userId)return!0;return!1};router.all("/save",function(a,b,c){action[a.query.action](a,b,c)}),router.get("/:id",function(a,b,c){void 0===a.session.state&&(a.session.state=2);var d=generalFunc.preCheck(a,!1);if(d.rc>0)return b.json(d);var e=a.params.id;return input_validate.article.hashId.type.define.test(e)?void b.status(200).render("article",{year:(new Date).getFullYear()}):b.json(input_validate.article.hashId.type.client)}),router.post("/",function(a,b,c){var d=generalFunc.preCheck(a,!1);if(d.rc>0)return b.json(d);var e=a.body.articleHashId;return void 0!=e&&regex.check(e,"testArticleHash")?void dbOperation.readArticle(e,function(c,d){if(0===d.rc){void 0===a.session.articleAuthor&&(a.session.articleAuthor=[]);var f,g=!1;f=a.session.articleAuthor.length<=generalDefine.articleAuthorSize?a.session.articleAuthor.length:generalDefine.articleAuthorSize;for(var h=0;f>h;h++)e==a.session.articleAuthor[h].articleHashId&&(a.session.articleAuthor[h].lastModified=(new Date).getTime(),g=!0);if(a.session.articleAuthor.length>=generalDefine.articleAuthorSize){var i=a.session.articleAuthor.length-generalDefine.articleAuthorSize+1;a.session.articleAuthor.sort(function(a,b){return a.lastModified<b.lastModified?1:-1}).splice(0,i)}return!1===g&&a.session.articleAuthor.push({articleHashId:e,authorId:d.msg.author._id,lastModified:(new Date).getTime()}),d.msg._id=void 0,d.msg.id=void 0,assistFunc.eliminateArrayId(d.msg.keys),assistFunc.eliminateArrayId(d.msg.innerImage),isOwner=isArticleOwner(a,d.msg.author._id),d.msg.author._id=void 0,d.msg.isOwner=isOwner,d.msg.userInfo=generalFunc.getUserInfo(a),b.json(d)}return b.json(d)}):b.json(input_validate.article.hashId.type.client)}),router.post("/readComment/:articleHashId",function(a,b,c){var d=generalFunc.preCheck(a,!1);if(d.rc>0)return b.json(d);var e=a.params.articleHashId;if(void 0===e||!regex.check(e,"testArticleHash"))return b.json(input_validate.article.hashId.type.client);var f;if(void 0===a.body.curPage||null===a.body.curPage||""===a.body.curPage||0>a.body.curPage)f=1;else if(f=parseInt(a.body.curPage,10),NaN===f)return b.json(runtimeNodeError.article.commentCurPageWrongFormat);dbOperation.readComment(e,f,function(a,c){return b.json(c)})}),router.post("/upload/:articleHashId",function(a,b,c){var d=generalFunc.preCheck(a,!0);if(d.rc>0)return b.json(d);var e=a.params.articleHashId;if(void 0==e||!regex.check(e,"testArticleHash"))return b.json(input_validate.article.hashId.type.client);if(!isArticleOwner(a,e))return b.json(runtimeNodeError.article.notArticleOwner);if(!fs.existsSync(uploadDefine.saveDir.define))return b.json(uploadDefine.saveDir.error);var f=new multiparty.Form({uploadDir:uploadDefine.saveDir.define,maxFilesSize:uploadDefine.maxFileSize.define});f.parse(a,function(a,c,d){JSON.stringify(d,null,2),JSON.stringify(c,null,2);if(a){var f="";switch(a.status){case 413:f="文件超过预定义大小"}return b.json({rc:a.status,msg:f})}var g=d.file[0],h=assistFunc.checkFile(g);if(!0!==h)return b.json(h.msg);var i=g.originalFilename.split(".").pop();-1!==uploadDefine.validImageSuffix.define.indexOf(i)&&assistFunc.checkImgFile(g.path,function(a,c){return c.rc>0?b.json(c):void 0});var j=g.path,k=(new Date).getTime(),l=g.originalFilename+k,m=hash.hash("sha1",l)+"."+i,n=uploadDefine.saveDir.define+m;fs.rename(j,n,function(a){if(a)return b.json(uploadDefine.renameFail.error);var c=new attachmentModel({hashName:m,name:g.originalFilename,storePath:uploadDefine.saveDir.define,size:g.size,cDate:(new Date).toLocaleString(),mDate:(new Date).toLocaleString()});dbOperation.addAttachment(e,c,function(a,c){if(0===c.rc){var d={};return d._id=c.msg._id,d.id=c.msg.id,d.name=c.msg.name,d.size=c.msg.size,d.cDataConv=c.msg.cDataConv,b.json({rc:0,msg:d})}return b.json(c)})})})}),router.get("/download/:file",function(a,b,c){var d=generalFunc.preCheck(a,!1);if(d.rc>0)return b.json(d);var e=a.params.file;return input_validate.attachment._id.type.define.test(e)?void dbOperation.getAttachmentHashName(e,function(a,c){if(0<c.rc)return b.json(c);var d=uploadDefine.saveDir.define+c.msg.hashName;fs.existsSync(d)&&b.download(d,c.msg.name)}):callback(null,input_validate.attachment._id.type.client)}),router.post("/removeAttachment",function(a,b,c){var d=generalFunc.preCheck(a,!0);if(d.rc>0)return b.json(d);var e=a.body.articleHashId,f=a.body.fileId;return void 0!==e&&regex.check(e,"testArticleHash")?void 0!==f&&input_validate.attachment._id.type.define.test(f)?void dbOperation.delAttachment(e,f,function(a,c){return 0===c.rc?(fs.unlinkSync(uploadDefine.saveDir.define+c.msg.hashName),b.json({rc:0,msg:null})):b.json(c)}):b.json(input_validate.attachment._id.type.client):b.json(input_validate.article.hashId.type.client)}),router.post("/addComment/:articleHashId",function(a,b,c){var d=generalFunc.preCheck(a,!0);if(d.rc>0)return b.json(d);var e=a.params.articleHashId;if(void 0==e||!regex.check(e,"testArticleHash"))return b.json(input_validate.article.hashId.type.client);if(1!=a.session.state)return b.json(runtimeNodeError.article.notLogin);var f=a.body.content;return""===f||null===f|void 0===f?b.json(input_validate.comment.content.require.client):f.length>input_validate.comment.content.maxLength.define?b.json(input_validate.comment.content.maxLength.client):2!=a.session.state&&1!=a.session.state?b.json(runtimeNodeError.article.noAuthToAddComment):void dbOperation.addComment(e,a.session.userId,f,function(a,c){return 0<c.rc?b.json(c):void dbOperation.readComment(e,"last",function(a,c){return b.json(c)})})}),router.post("/saveContent/:articleHashId",function(a,b,c){var d=generalFunc.preCheck(a,!0);if(d.rc>0)return b.json(d);var e=a.params.articleHashId;if(void 0==e||!regex.check(e,"testArticleHash"))return b.json(input_validate.article.hashId.type.client);if(!isArticleOwner(a,e))return b.json(runtimeNodeError.article.notArticleOwner);var f=a.body.keys,g={title:a.body.title,pureContent:a.body.pureContent,htmlContent:a.body.htmlContent};if(void 0!=f&&null!=f&&f.length>input_validate.article.keys.maxSize.define)return b.json(input_validate.article.keys.maxSize.client);for(var h=0;h<f.length;h++)if(!input_validate.key.key.type.define.test(f[h]))return b.json(input_validate.key.key.type.client);for(var i,j=["title","pureContent","htmlContent"],h=0;h<j.length;h++){if(i=j[h],void 0!=input_validate.article[i].require&&!0===input_validate.article[i].require.define&&(void 0===g[i]||null===g[i]||""===g[i]))return b.json(input_validate.article[i].require.client);if(void 0!=input_validate.article[i].minLength&&void 0!=input_validate.article[i].minLength.define&&void 0!=g[i]&&null!=g[i]&&g[i].length<input_validate.article[i].minLength.define)return b.json(input_validate.article[i].minLength.client);if(void 0!=input_validate.article[i].maxLength&&void 0!=input_validate.article[i].maxLength.define&&void 0!=g[i]&&null!=g[i]&&g[i].length>input_validate.article[i].maxLength.define)return b.json(input_validate.article[i].maxLength.client)}dbOperation.updateArticleKey(e,f,function(a,c){return 0!==c.rc?b.json(c):void dbOperation.updateArticleContent(e,g,function(a,c){return b.json(c)})})});var action={uploadimage:function(a,b,c){var d={state:"",url:"",title:"",original:""},e=a.query.articleID;if(!input_validate.article.hashId.type.define.test(e))return d.state=input_validate.article.hashId.type.client.msg,b.json(d);if(!isArticleOwner(a,e))return d.state=input_validate.article.notArticleOwner.msg,b.json(d);var f=general.ueUploadPath+"/"+ue_config.imagePathFormat;if(!fs.existsSync(f))return recorderError(runtimeNodeError.article.uploadImageDirNotExist,"article","uploadimage"),d.state=runtimeNodeError.article.uploadImageDirNotExist.msg,b.json(d);var g=new multiparty.Form({uploadDir:f,maxFilesSize:ue_config.imageMaxSize});g.parse(a,function(a,c,g){if(a){switch(a.status){case 413:return d.state=runtimeNodeError.article.exceedMaxFileSize,b.json(d)}}var h=g.file[0],i=assistFunc.checkFile(h);if(!0!==i)return b.json(i);var j=h.originalFilename.split(".").pop();-1!=ue_config.imageAllowFiles.indexOf("."+j)&&assistFunc.checkImgFile(h.path,function(a,c){if(c.rc>0)return d.state=c.msg,b.json(d);var g=h.path,i=(new Date).getTime(),k=h.originalFilename+i,l=hash.hash("sha1",k)+"."+j,m=f+"/"+l;fs.rename(g,m,function(a){if(a)return recorderError({rc:a.code,msg:"重命名"+g+"为"+m+"失败"},"article","uploadImage"),d.state=uploadDefine.renameFail.error,b.json(d);var c=new innerImageModel({hashName:l,name:h.originalFilename,storePath:f,size:h.size,cDate:new Date});dbOperation.addInnerImage(e,c,function(a,c){return d.state="SUCCESS",d.url=c.msg.hashName,d.title=c.msg.name,b.json(d)})})})})},config:function(a,b,c){return b.json(ue_config)}};router.post("/uploadPreCheck",function(a,b,c){var d=generalFunc.preCheck(a,!0);if(d.rc>0)return b.json(d);var e=a.body.file;if(e&&e.length>0){for(var f=0;f<e.length;f++){var g=e[f],h=assistFunc.checkFile(g);!0===h||(g.msg=h.msg)}return b.json({rc:0,data:e})}return b.json({rc:450,msg:"上传文件参数不正确"})}),module.exports=router;