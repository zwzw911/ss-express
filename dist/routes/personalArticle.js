var express=require("express"),router=express.Router(),runtimeNodeError=require("./error_define/runtime_node_error").runtime_node_error,input_validate=require("./error_define/input_validate").input_validate,validateFolder=input_validate.folder,validateArticleFolder=input_validate.articleFolder,general=require("./assist/general").general,dbOperation=require("./model/personalArticle").personalArticleDbOperation,articleDbOperation=require("./model/article").articleDboperation,generalFunc=require("./express_component/generalFunction").generateFunction,miscellaneousFunc=require("./assist_function/miscellaneous").func,async=require("async"),pagination=require("./express_component/pagination").pagination,sanitySingleNode=function(a){void 0!=a.title&&(a.folder=!1,a.edit=!1,a._id=void 0,a.id=a.hashId,a.hashId=void 0,a.author=void 0,a.type="fa-file-o",a.state=a.state,a.mDate=a.mDateConv,a.tableEdit=!1),void 0!=a.folderName&&(a.level=void 0,a.parentId=void 0,a.owner=void 0,a._id=void 0,a.mDate=void 0,a.folder=!0,a.edit=!1,null===a.nodes||void 0===a.nodes?a.nodes=[]:a.nodes,a.title=a.folderName,a.folderName=void 0)},sanityFolderAndArticle=function(a){if(a.constructor===Object&&sanitySingleNode(a),a.constructor===Array)for(var b=a.length,c=0;b>c;c++){var d=a[c];void 0!=d.nodes&&d.nodes.length>0&&sanityFolderAndArticle(d.nodes),sanitySingleNode(d)}};router.get("/",function(a,b,c){if(1!=a.session.state)return b.redirect("/login");var d=generalFunc.preCheck(a,!0);if(d.rc>0)return b.json(d);var e=generalFunc.checkInterval(a);return e.rc>0?b.render("error_page/error"):b.render("personalArticle",{title:"个人文档",year:(new Date).getFullYear()})}),router.post("/",function(a,b,c){var d=generalFunc.preCheck(a,!0);if(d.rc>0)return b.json(d);var e=a.session.userId,f=general.defaultRootFolderName,g=[];async.forEachOf(f,function(a,c,d){dbOperation.readRootFolder(e,a,function(a,e){return 0<e.rc?b.json(e):(g[c]=e.msg.toObject(),void d())})},function(c){if(c)return b.json(null,c);var d={};return sanityFolderAndArticle(g),d.defaultRootFolder=g,d.userInfo=generalFunc.getUserInfo(a),b.json({rc:0,msg:d})})}),router.post("/checkIfRootFolder",function(a,b,c){var d=generalFunc.preCheck(a,!0);if(d.rc>0)return b.json(d);var e=(a.session.userId,a.body.folderId);return void 0!==e&&validateFolder._id.type.define.test(e)?void dbOperation.checkIfRootFolder(e,function(a,c){return b.json(c)}):b.json(validateFolder._id.type.client)}),router.post("/readFolder",function(a,b,c){var d=generalFunc.preCheck(a,!0);if(d.rc>0)return b.json(d);var e=a.session.userId,f=a.body.folderId;if(void 0===f||!validateFolder._id.type.define.test(f))return b.json(validateFolder._id.type.client);var g=[];dbOperation.readFolder(e,f,function(a,c){var d=c.msg.length;if(d>0)for(var h=0;d>h;h++)g.push(c.msg[h].toObject());dbOperation.readArticleInFolder(e,f,function(a,c){if(0<c.rc)return b.json(c);var d=c.msg;if(0<d.length)for(var e=0;e<d.length;e++)g.push(d[e].articleId.toObject());sanityFolderAndArticle(g);var f=pagination(d.length,1,general.articleFolderPageSize,general.articleFolderPageLength);return b.json({rc:0,msg:g,pagination:f})})})}),router.post("/pagination",function(a,b,c){var d=generalFunc.preCheck(a,!0);if(d.rc>0)return b.json(d);var e=a.body.total,f=a.body.curPage;if(isNaN(e))return b.json(runtimeNodeError.article.articleNumNotInt);if(-1===general.validPaginationString.indexOf(f)&&isNaN(parseInt(f)))return b.json(runtimeNodeError.general.invalidPaginationString);var g=pagination(e,f,general.articleFolderPageSize,general.articleFolderPageLength);return b.json({rc:0,msg:g})}),router.post("/rename",function(a,b,c){var d=generalFunc.preCheck(a,!0);if(d.rc>0)return b.json(d);var e=a.session.userId,f=a.body.folderId,g=a.body.oldFolderName,h=a.body.newFolderName;return void 0!==f&&validateFolder._id.type.define.test(f)?void 0!==g&&validateFolder.folderName.type.define.test(g)&&void 0!==h&&validateFolder.folderName.type.define.test(h)?void dbOperation.modifyFolderName(e,f,g,h,function(a,c){return 0<c.rc?b.json(c):b.json({rc:0,msg:null})}):b.json(validateFolder.folderName.type.client):b.json(validateFolder._id.type.client)}),router.post("/moveFolder",function(a,b,c){var d=generalFunc.preCheck(a,!0);if(d.rc>0)return b.json(d);var e=a.session.userId,f=a.body.folderId,g=a.body.oldParentFolderId,h=a.body.newParentFolderId;if(null===g||void 0===g)return callback(null,runtimeNodeError.folder.cantMoveDefaultFolder);if(g===h)return b.json({rc:0,msg:null});for(var i=[f,g,h],j=i.length,k=0;j>k;k++)if(void 0===i[k]||!validateFolder._id.type.define.test(i[k]))return b.json(validateFolder._id.type.client);dbOperation.moveFolder(e,f,g,h,function(a,c){return 0<c.rc?b.json(c):b.json({rc:0,msg:null})})}),router.post("/createFolder",function(a,b,c){var d=generalFunc.preCheck(a,!0);if(d.rc>0)return b.json(d);var e=a.session.userId,f=a.body.parentFolderId,g=a.body.folderName;return void 0!==f&&validateFolder._id.type.define.test(f)?((void 0===g||null===g||""===g)&&(g="新建文件夹"),void 0!==g&&validateFolder.folderName.type.define.test(g)?void dbOperation.createNewFolder(e,f,g,function(a,c){if(0<c.rc)return b.json(c);var d=c.msg.toObject();return sanityFolderAndArticle(d),b.json({rc:0,msg:d})}):b.json(validateFolder.folderName.type.client)):b.json(validateFolder._id.type.client)}),router.post("/deleteFolder",function(a,b,c){var d=generalFunc.preCheck(a,!0);if(d.rc>0)return b.json(d);var e=a.session.userId,f=a.body.folderId;if(void 0===f||!validateFolder._id.type.define.test(f))return b.json(validateFolder._id.type.client);var g=0;dbOperation.countSubFolder(e,f,function(a,c){return 0<c.rc?b.json(c):(g+=c.msg,void dbOperation.countSubArticle(e,f,function(a,c){return c>0?b.json(c):(g+=c.msg,g>0?b.json(runtimeNodeError.folder.hasChildNotDelete):void dbOperation.deleteFolder(e,f,function(a,c){return b.json(c)}))}))})}),router.post("/createArticleFolder",function(a,b,c){var d=generalFunc.preCheck(a,!0);if(d.rc>0)return b.json(d);var e=a.session.userId,f=a.body.parentFolderId;return void 0!==f&&validateFolder._id.type.define.test(f)?void articleDbOperation.createNewArticle("新建文件",e,function(a,c){if(0<c.rc)return callback(null,c);var d=c.msg.articleId,g=c.msg.articleHashId;dbOperation.createArticleFolder(e,d,f,function(a,c){if(0<c.rc)return b.json(c);var d=c.msg;return d.hashId=g,sanityFolderAndArticle(d),b.json({rc:0,msg:d})})}):b.json(validateFolder._id.type.client)}),router.post("/removeArticle",function(a,b,c){var d=generalFunc.preCheck(a,!0);if(d.rc>0)return b.json(d);var e=a.session.userId,f=a.body.articleHashId;return void 0!==f&&input_validate.article.hashId.type.define.test(f)?void articleDbOperation.readArticle(f,function(a,c){if(0<c.rc)return callback(null,c);var d=c.msg._id;dbOperation.removeArticleFolder(e,d,function(a,c){return b.json(c)})}):b.json(input_validate.article.hashId.type.client)}),router.post("/deleteArticle",function(a,b,c){var d=generalFunc.preCheck(a,!0);if(d.rc>0)return b.json(d);var e=a.session.userId,f=a.body.articleHashId,g=a.body.oldParentFolderId;if(void 0===f||!input_validate.article.hashId.type.define.test(f))return b.json(validateArticleFolder.articleId.type.client);if(void 0===g||!validateFolder._id.type.define.test(g))return b.json(validateFolder._id.type.client);var h=general.defaultRootFolderName;dbOperation.readRootFolder(e,h[1],function(a,c){if(0<c.rc)return callback(c);var d=c.msg._id;dbOperation.moveArticle(e,f,g,d,function(a,c){return 0<c.rc?b.json(c):b.json({rc:0,msg:null})})})}),router.post("/moveArticle",function(a,b,c){var d=generalFunc.preCheck(a,!0);if(d.rc>0)return b.json(d);var e=a.session.userId,f=a.body.articleId,g=a.body.oldParentFolderId,h=a.body.newParentFolderId;if(g===h)return b.json({rc:0,msg:null});for(var i=[g,h],j=i.length,k=0;j>k;k++)if(void 0===i[k]||!validateFolder._id.type.define.test(i[k]))return b.json(validateFolder._id.type.client);return void 0!==f&&validateArticleFolder.articleId.type.define.test(f)?void dbOperation.moveArticle(e,f,g,h,function(a,c){return 0<c.rc?b.json(c):b.json({rc:0,msg:null})}):b.json(validateArticleFolder.articleId.type.client)}),router.post("/updateArticle",function(a,b,c){var d=generalFunc.preCheck(a,!0);if(d.rc>0)return b.json(d);var e=(a.session.userId,a.body.articleHashId),f=a.body.articleNewName,g=a.body.state;return void 0!==e&&validateArticleFolder.articleId.type.define.test(e)?void articleDbOperation.updateArticleContent(e,{title:f,state:g},function(a,c){return b.json(c)}):b.json(validateArticleFolder.articleId.type.client)}),module.exports=router;