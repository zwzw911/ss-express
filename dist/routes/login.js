var express=require("express"),router=express.Router(),cookieSessionClass=require("./express_component/cookieSession"),fs=require("fs"),captchaInst=require("./express_component/awesomeCaptcha").captcha,hashCrypto=require("./express_component/hashCrypt"),async=require("async"),general=require("./assist/general").general,generalFunc=require("./express_component/generalFunction").generateFunction,input_validate=require("./error_define/input_validate").input_validate,runtimeDbError=require("./error_define/runtime_db_error").runtime_db_error,runtimeNodeError=require("./error_define/runtime_node_error").runtime_node_error,options={},captchaParams={},pemFilePath=generalFunc.getPemFile(general.pemPath),userDbOperation=require("./model/user").userDbOperation,failThenGenCaptcha=function(a,b,c){captchaInst.captcha(captchaParams,function(d,e,f,g){return d?c(null,runtimeNodeError.user.genCaptchaFail):(a.session.captcha=e,a.session.captchaPath=g+"/"+f,b.url=f,c(d,b))})};router.get("/",function(a,b,c){a.session.state=2;var d=generalFunc.preCheck(a,!1);return d.rc>0?b.json(d):void captchaInst.captcha(captchaParams,function(c,d,e,f){if(c)return b.json(runtimeNodeError.user.genCaptchaFail);var g,h;if(h=a.signedCookies.rememberMe,g=void 0===h||""===h?!1:!0,!0===g)var i=hashCrypto.decrypt(null,h,pemFilePath);else var i="";return a.session.captcha=d,a.session.captchaPath=f+"/"+e,b.render("login",{title:"登录",img:e,rememberMe:g,decryptName:i,year:(new Date).getFullYear()})})}),router.post("/regen_captcha",function(a,b,c){var d=generalFunc.preCheck(a,!1);if(d.rc>0)return b.json(d);if(2===a.session.state){void 0!=a.session.captchaPath&&fs.unlinkSync(a.session.captchaPath);var e={rc:0};failThenGenCaptcha(a,e,function(a,c){return b.json(c)})}}),router.post("/loginUser",function(a,b,c){var d=generalFunc.preCheck(a,!1);if(d.rc>0)return b.json(d);var e,f=a.body.name,g=a.body.pwd,h=a.body.captcha,i=a.body.rememberMe;return void 0===e&&void 0===f&&(e=input_validate.user.name.require.server),void 0===e&&void 0===g&&(e=input_validate.user.password.require.server),void 0===e&&void 0===h&&(e=input_validate.user.captcha.require.client),void 0===e&&void 0===i&&(i=!1),void 0!=a.session.captchaPath&&fs.unlinkSync(a.session.captchaPath),void 0!==e||input_validate.user.name.type.define.test(f)||(e=input_validate.user.name.type.client),void 0!==e||input_validate.user.password.type.define.test(g)||(e=input_validate.user.password.type.client),void 0!==e||input_validate.user.captcha.type.define.test(h)||(e=input_validate.user.captcha.type.client),void 0===e&&h.toUpperCase()!=a.session.captcha&&(e=runtimeNodeError.user.captchaVerifyFail),void 0===e&&"true"!==i&&"false"!==i&&(e=runtimeNodeError.user.rememberMeTypeWrong),void 0!==e?void failThenGenCaptcha(a,e,function(a,c){return b.json(c)}):(g=hashCrypto.hmac("sha1",g,pemFilePath),void userDbOperation.checkUserValidate(f,g,function(c,d){if(0<d.rc)return void failThenGenCaptcha(a,d,function(a,c){return b.json(c)});if(!0===i){var e={};for(var g in cookieSessionClass.cookieOptions)e[g]=cookieSessionClass.cookieOptions[g];e.maxAge=864e5,e.signed=!0;var h=hashCrypto.crypt(null,f,pemFilePath);b.cookie("rememberMe",h,e)}else b.clearCookie("rememberMe",cookieSessionClass.cookieOptions);return a.session.state=1,a.session.userId=d.msg._id,a.session.userName=d.msg.name,a.session.captcha=void 0,a.session.captchaPath=void 0,b.json({rc:0})}))}),module.exports=router;