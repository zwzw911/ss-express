var ue=UE.getEditor("container"),searchString=window.location.href,id=searchString.split("/").pop();ue.setOpt("serverUrl","save?articleID="+id);var app=angular.module("app",["ngFileUpload","inputDefineApp","generalFuncApp"]);app.factory("articleService",["$http",function(a){var b=function(b){return a.post("uploadPreCheck",{file:b},{})},c=function(b){return a.post("/article",{articleHashId:b},{})},d=function(b,c,d,e,f){return a.post("saveContent/"+b,{title:c,keys:d,pureContent:e,htmlContent:f},{})},e=function(b,c){return a.post("addComment/"+b,{content:c},{})},f=function(b,c){return a.post("readComment/"+b,{curPage:c},{})},g=function(b,c){return a.post("removeAttachment/",{articleHashId:b,fileId:c},{})};return{preCheckUploadFiles:b,saveContent:d,getData:c,addComment:e,readComment:f,removeAttachment:g}}]),app.controller("ArticleController",["$scope","$location","$window","Upload","articleService","$sce","func","inputDefine",function(a,b,c,d,e,f,g,h){a.userInfo=void 0,a.showEdit=!1,a.article={editFlag:!1};var i=function(){var a=b.absUrl(),c=a.split("/").pop();return void 0!==c&&""!==c&&h.article.hashId.define.test(c)?c:!1},j=function(a){var b=[];if(a.msg.comment.length>0)for(var c,d=0;d<a.msg.comment.length;d++)c={},c.id=a.msg.comment[d].id,c.content=a.msg.comment[d].content,c.mDateConv=a.msg.comment[d].mDateConv,void 0!=a.msg.comment[d].user&&(c.user=a.msg.comment[d].user,c.user.thumbnail=c.user.thumbnail,c.user.cDate=g.getDate(c.user.mDateConv)),b.push(c);return b};a.addNewKey=function(){if(a.article.keys.content.length<a.article.keys.define.maxSize){var b={value:"",leftNumFlag:!1,leftNum:null,errorFlag:!1,errorMsg:"",errorClass:""};a.article.keys.content.push(b)}else a.errorModal=g.showErrMsg("最多"+a.article.keys.define.maxSize+"关键字")},a.btn={edit:{disabled:!1,name:"edit"},cancel:{disabled:!0,name:"cancel"},save:{disabled:!0,name:"save"}},a.btnClick=function(b){"edit"===b.name&&(a.btn.edit.disabled=!0,a.btn.cancel.disabled=!1,a.btn.save.disabled=!1),("cancel"===b.name||"save"===b.name)&&(a.btn.edit.disabled=!1,a.btn.cancel.disabled=!0,a.btn.save.disabled=!0),a.article.editFlag=!a.article.editFlag},a.calcLeftNum=function(b,c){var d=a.article[b].define.maxLength;if("keys"===b)var e=a.article[b].content[c];else var e=a.article[b];e.errorFlag=!1,e.errorMsg="",e.leftNumFlag=!1,e.errorClass="";var f=e.value,g=f.length;a.article[b].define.required&&0===g&&(e.leftNumFlag=!1,e.errorFlag=!0,e.errorMsg="不能为空",e.errorClass="has-error"),d-g>=0?e.leftNum=d-g:(e.leftNum=0,e.value=f.substring(0,d)),e.leftNumFlag=!0},a.saveContent=function(){var b=i();if(!1===b)return a.errorModal=g.showErrMsg("当前文档的ID不正确"),!1;for(var c=[],d=0;d<a.article.keys.content.length;d++)""!=a.article.keys.content[d].value&&a.article.keys.content[d].value.length<a.article.keys.define.maxLength&&c.push(a.article.keys.content[d].value);var h=a.article.title.value,j=ue.getContentTxt(),k=ue.getContent(),l=e.saveContent(b,h,c,j,k);l.success(function(b,c,d,e){return 0!==b.rc?(a.errorModal=g.showErrMsg(b.msg),!1):(a.article.pureContent.value=j,a.article.htmlContent.value=f.trustAsHtml(k),a.article.editFlag=!1,void 0)}).error(function(a,b,c,d){})};var k=function(a){if(void 0===a||"object"!=typeof a)return!1;var b,c=["jpeg","jpg","png","gif","bmp"],d=["txt","log","html"],e=["doc","docx"],f=["xls","xlsx"],g=["ppt","pptx","pps"],h=["avi"],i=["zip","tar"];b=a.name.split(".").pop(),-1!=c.indexOf(b)&&(a.icon="fa fa-file-image-o"),-1!=d.indexOf(b)&&(a.icon="fa fa-file-text-o"),-1!=e.indexOf(b)&&(a.icon="fa fa-file-word-o"),-1!=f.indexOf(b)&&(a.icon="fa fa-file-excel-o"),-1!=g.indexOf(b)&&(a.icon="fa fa-file-powerpoint-o"),-1!=h.indexOf(b)&&(a.icon="fa fa-file-video-o"),-1!=i.indexOf(b)&&(a.icon="fa fa-file-zip-o"),void 0===a.icon&&(a.icon="fa fa-file-o"),a.size=(a.size/1024/1024).toFixed(2)},l=function(a){return void 0===a||0===a.length?!1:void a.forEach(function(a){k(a)})};a.uploadDefine=h.uploadDefine;var m=h.mimes;a.uploadStatusConfig={0:{css:"text-muted",msg:"准备上传"},1:{css:"text-info",msg:"上传中"},2:{css:"text-success",msg:"上传完毕"},3:{css:"text-danger",msg:"停止上传"},4:{css:"text-danger",msg:"上传失败"}};var n=function(a){a.status=0,a.roughSize=(a.size/1024/1024).toFixed(2),a.uploadPercentage=0,a.loadedSize=0,a.errorFlag=!1,a.errorMsg="",a.progressBarClass=""},o=function(a){a.status=2,a.errorFlag=!1,a.errorMsg="",a.progressBarClass="progress-bar-success"},p=function(a,b){a.status=4,a.errorFlag=!0,a.errorMsg=b,a.progressBarClass="progress-bar-danger"},q=function(a){var b=[];if(a&&a.length>0)for(var c=0;c<a.length;c++){var d=a[c],e={originalFilename:d.name,headers:{"content-type":d.type},size:d.size};b.push(e)}return b};a.filesList=[],a.$watch("files",function(b){if(void 0!=a.files&&a.files.length>0)for(var c=0;c<b.length;c++){var d=b[c];if(void 0===d.status){n(d),a.uploadDefine.maxSize.define<d.size&&p(d,a.uploadDefine.maxSize.msg),a.uploadDefine.fileNameLength.define<d.name.length&&p(d,a.uploadDefine.fileNameLength.msg);var f=d.name.split(".");if(f.length<2)p(d,a.uploadDefine.validSuffix.msg);else{var g=f.pop();(0===g.length||-1===a.uploadDefine.validSuffix.define.indexOf(g)||-1===m[g].indexOf(d.type))&&p(d,a.uploadDefine.validSuffix.msg)}a.filesList.push(d);var h=e.preCheckUploadFiles(q(a.filesList));h.success(function(b,c,d,e){if(0===b.rc)for(var f=0;f<a.filesList.length;f++)b.data[f].msg?p(a.filesList[f],b.data[f].msg):n(a.filesList[f])}).error(function(a,b,c,d){})}}}),a.upload=function(b){var c=i();if(!1===c)return a.errorModal=g.showErrMsg("当前文档的ID不正确"),!1;if(b&&b.length)for(var e=0;e<b.length;e++){var f=b[e];(0==f.status||3==f.status)&&d.upload({url:"upload/"+c,fields:{username:a.username},file:f}).progress(function(a){a.config.file.status=1;var b=parseInt(100*a.loaded/a.total);a.config.file.uploadPercentage=b,a.config.file.loadedSize=(a.loaded/1024/1024).toFixed(2)}).success(function(b,c,d,e){0===b.rc?(o(e.file),k(b.msg),a.article.attachment.value.push(b.msg)):p(e.file,b.msg)}).error(function(a,b,c,d){d.file.status=4,p(d.file,a.msg)})}},a.removeUploadFile=function(b){a.filesList.splice(b,1)};var r=function(){var b=i();if(!1===b)return c.location.href="articleNotExist",!1;var d=e.getData(b);d.success(function(b,d,e,h){switch(b.rc){case 0:if(a.userInfo=b.msg.userInfo,a.showEdit=b.msg.isOwner,a.article={editFlag:!1,title:{value:b.msg.title,lastModifiedDate:b.msg.mDate,leftNumFlag:!1,leftNum:null,errorFlag:!1,errorMsg:"",errorClass:"",define:{required:!0,maxLength:255}},author:{value:b.msg.author.name},cDate:{value:b.msg.mDateConv},keys:{content:[],define:{required:!1,maxLength:100,maxSize:5}},pureContent:{value:b.msg.pureContent,leftNumFlag:!1,leftNum:null,errorFlag:!1,errorMsg:"",errorClass:"",define:{required:!1,maxLength:8e3}},htmlContent:{value:f.trustAsHtml(b.msg.htmlContent),leftNumFlag:!1,leftNum:null,errorFlag:!1,errorMsg:"",define:{required:!1,maxLength:12e3}},attachment:{value:[],define:{required:!1,maxLength:5}},newComment:{value:"",leftNumFlag:!1,leftNum:null,errorFlag:!1,errorMsg:"",define:{required:!0,maxLength:255}},comment:[],commentPagination:b.msg.pagination,commentGotoPage:""},ue.ready(function(){b.msg.htmlContent?ue.setContent(b.msg.htmlContent.toString()):ue.setContent("")}),b.msg.keys.length>0)for(var i=0;i<b.msg.keys.length;i++){var k={};k.value=b.msg.keys[i],k.leftNumFlag=!1,k.leftNum=null,k.errorFlag=!1,k.errorMsg="",k.errorClass="",a.article.keys.content.push(k)}b.msg.attachment.length>0&&(a.article.attachment.value=b.msg.attachment,l(a.article.attachment.value)),a.article.comment=j(b),a.article.commentPagination.pageRange=g.generatePaginationRange(b.msg.pagination);break;case 500:c.location.href="articleNotExist";break;default:a.errorModal=g.showErrMsg(b.msg)}}).error(function(a,b,c,d){})};setTimeout(function(){r()},1e3);var s=function(b){a.article.newComment.errorFlag=!0,a.article.newComment.errorMsg=b,a.article.newComment.errorClass=""};a.addComment=function(){var b=i();if(!1===b)return a.errorModal=g.showErrMsg("当前文档的ID不正确"),!1;var c=a.article.newComment;if(""===c.value)return s("回复内容不能为空"),!1;if(c.value.length>c.define.maxLength)return s("回复最多包含255个字符"),!1;var d=e.addComment(b,c.value);d.success(function(b,c,d,e){switch(b.rc){case 0:a.article.comment=j(b),a.article.newComment.value="",a.article.commentPagination=b.msg.pagination,a.article.commentPagination.pageRange=g.generatePaginationRange(b.msg.pagination);break;default:a.errorModal=g.showErrMsg(b.msg)}}).error(function(a,b,c,d){})},a.readComment=function(b){var d=i();!1===d&&(c.location.href="articleNotExist");var f=e.readComment(d,b);f.success(function(b,c,d,e){return 0<b.rc?(a.errorModal=g.showErrMsg(b.msg),!1):(a.article.comment=j(b),a.article.commentPagination=b.msg.pagination,void(a.article.commentPagination.pageRange=g.generatePaginationRange(b.msg.pagination)))}).error(function(a,b,c,d){})},a.removeAttachment=function(b){var c=a.article.attachment.value[b].id,d=i(),f=e.removeAttachment(d,c);f.success(function(c,d,e,f){return 0<c.rc?(a.errorModal=g.showErrMsg(c.msg),!1):void a.article.attachment.value.splice(b,1)}).error(function(a,b,c,d){})},a.quit=function(){var a=g.quit();a.success(function(a,b,d,e){0===a.rc&&(c.location.href="main")}).error(function(a,b,c,d){})},a.search=function(){var b=g.convertInputSearchString(a.searchString,h.search.searchTotalKeyLen.define);return!1===b?!1:void(c.location.href="searchResult?wd="+b)}}]);